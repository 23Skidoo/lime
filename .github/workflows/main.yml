name: CI

on: [push, pull_request]

jobs:

  build:

    strategy:
      matrix:
        haxe-version: [3.4.7, 4.1.5]
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: haxeui/haxeui-core/.github/actions/haxe@master
      with:
        haxe-version: ${{ matrix.haxe-version }}
    - uses: actions/setup-java@v1
      with:
        java-version: 8

    - name: Install Haxe dependencies
      run: |
        haxelib install hxcpp 4.0.64 --quiet
        haxelib install format  --quiet
        haxelib install hxp  --quiet
        haxelib git lime-samples https://github.com/openfl/lime-samples --quiet

    - name: Configure HXCPP compile cache (Linux/macOS)
      if: ${{ !startsWith(matrix.os, 'windows-') }}
      run: |
        echo "HXCPP_COMPILE_CACHE=~/.hxcpp" >> $GITHUB_ENV

    - name: Configure HXCPP compile cache (Windows)
      if: ${{ startsWith(matrix.os, 'windows-') }}
      run: |
        echo "HXCPP_COMPILE_CACHE=C:\.hxcpp" >> $GITHUB_ENV

    - name: Install system dependencies (Linux)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev g++-multilib gcc-multilib libasound2-dev libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev

    - name: Install "lime" command alias (Linux/macOS)
      if: ${{ !startsWith(matrix.os, 'windows-') }}
      run: |
        haxelib dev lime $GITHUB_WORKSPACE
        haxelib run lime setup -alias -y
        lime || alias lime="haxelib run lime"

    - name: Install "lime" command alias (Windows)
      if: ${{ startsWith(matrix.os, 'windows-') }}
      run: |
        haxelib dev lime $Env:GITHUB_WORKSPACE
        haxelib run lime setup -alias -y

    - name: Configure Android support (Linux)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        mkdir -p ~/.android-ndk-r15c
        wget -O android-ndk.zip --quiet https://dl.google.com/android/repository/android-ndk-r15c-linux-x86_64.zip
        unzip -qq android-ndk.zip -d ~/.android-ndk-r15c
        rm android-ndk.zip
        lime config ANDROID_SDK $ANDROID_HOME
        haxelib run lime config ANDROID_NDK_ROOT ~/.android-ndk-r15c
        haxelib run lime config JAVA_HOME $JAVA_HOME
        haxelib run lime config ANDROID_SETUP true
        haxelib run lime config

    - name: Rebuild Lime tools
      run: |
        lime rebuild tools -nocolor -verbose

    - name: Rebuild Lime (HashLink)
      run: |
        lime rebuild hl -release -verbose -nocolor

    - name: Rebuild Lime (Android)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        lime rebuild android -release -verbose -nocolor

    - name: Rebuild Lime (iOS)
      if: ${{ startsWith(matrix.os, 'macos-') }}
      run: |
        lime rebuild ios -release -verbose -nocolor

    - name: Rebuild Lime (Linux)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        lime rebuild linux -64 -release -verbose -nocolor
        lime rebuild linux -32 -release -verbose -nocolor

    - name: Rebuild Lime (macOS)
      if: ${{ startsWith(matrix.os, 'macos-') }}
      run: |
        lime rebuild mac -release -verbose -nocolor

    - name: Rebuild Lime (Windows)
      if: ${{ startsWith(matrix.os, 'windows-') }}
      run: |
        lime rebuild windows -32 -release -verbose -nocolor
        lime rebuild windows -64 -release -verbose -nocolor

    - name: Create Lime samples
      run: |
        lime create HelloWorld -verbose -nocolor
        lime create SimpleImage -verbose -nocolor
        lime create SimpleAudio -verbose -nocolor

    - name: Build Lime samples (HTML5)
      run: |
        lime build HelloWorld html5 -release -verbose -nocolor
        lime build HelloWorld html5 -Dcanvas -release -verbose -nocolor
        lime build HelloWorld html5 -Ddom -release -verbose -nocolor
        lime build SimpleImage html5 -release -verbose -nocolor
        lime build SimpleImage html5 -Dcanvas -release -verbose -nocolor
        lime build SimpleImage html5 -Ddom -release -verbose -nocolor
        lime build SimpleAudio html5 -release -verbose -nocolor
        lime build SimpleAudio html5 -Dcanvas -release -verbose -nocolor
        lime build SimpleAudio html5 -Ddom -release -verbose -nocolor

    - name: Build Lime samples (Flash)
      run: |
        lime build HelloWorld flash -release -verbose -nocolor
        lime build SimpleImage flash -release -verbose -nocolor
        lime build SimpleAudio flash -release -verbose -nocolor

    - name: Build Lime samples (Neko)
      run: |
        lime build HelloWorld neko -release -verbose -nocolor
        lime build SimpleImage neko -release -verbose -nocolor
        lime build SimpleAudio neko -release -verbose -nocolor

    #- name: Build Lime samples (HashLink)
    #  if: ${{ !startsWith(matrix.haxe-version, '3.') }}
    #  run: |
    #    lime build HelloWorld hl -release -verbose -nocolor
    #    lime build SimpleImage hl -release -verbose -nocolor
    #    lime build SimpleAudio hl -release -verbose -nocolor

    - name: Build Lime samples (Android)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        lime build HelloWorld android -release -verbose -nocolor
        lime build SimpleImage android -release -verbose -nocolor
        lime build SimpleAudio android -release -verbose -nocolor

    - name: Build Lime samples (Linux)
      if: ${{ startsWith(matrix.os, 'ubuntu-') }}
      run: |
        lime build HelloWorld linux -release -verbose -nocolor
        lime build SimpleImage linux -release -verbose -nocolor
        lime build SimpleAudio linux -release -verbose -nocolor

    - name: Build Lime samples (macOS)
      if: ${{ startsWith(matrix.os, 'macos-') }}
      run: |
        lime build HelloWorld mac -release -verbose -nocolor
        lime build SimpleImage mac -release -verbose -nocolor
        lime build SimpleAudio mac -release -verbose -nocolor

    - name: Build Lime samples (iOS)
      if: ${{ startsWith(matrix.os, 'macos-') }}
      run: |
        lime build HelloWorld ios -simulator -release -verbose -nocolor
        lime build SimpleImage ios -simulator -release -verbose -nocolor
        lime build SimpleAudio ios -simulator -release -verbose -nocolor

    - name: Build Lime samples (Windows)
      if: ${{ startsWith(matrix.os, 'windows-') }}
      run: |
        lime build HelloWorld windows -release -verbose -nocolor
        lime build SimpleImage windows -release -verbose -nocolor
        lime build SimpleAudio windows -release -verbose -nocolor

    - name: Notify Discord (success)
      uses: appleboy/discord-action@master
      if: github.event_name == 'push' || github.repository == github.event.pull_request.head.repo.full_name
      with:
        webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
        webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
        color: "#00C07F"
        message: "https://github.com/haxelime/lime/actions\nCI build succeeded."

    - name: Notify Discord (failure)
      uses: appleboy/discord-action@master
      if: failure() && (github.event_name == 'push' || github.repository == github.event.pull_request.head.repo.full_name)
      with:
        webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
        webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
        color: "#FF6562"
        message: "https://github.com/haxelime/lime/actions\nCI build failed."
